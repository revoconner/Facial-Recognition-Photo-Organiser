<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="title-bar">
        <div class="title-bar-drag">
            <div class="title-bar-title">Face Recognition Photo Organizer</div>
        </div>
        <div class="title-bar-controls">
            <button class="title-bar-btn minimize-btn" id="minimizeBtn" title="Minimize">
                <svg width="12" height="12" viewBox="0 0 12 12">
                    <rect x="0" y="5" width="12" height="2" fill="currentColor"/>
                </svg>
            </button>
            <button class="title-bar-btn maximize-btn" id="maximizeBtn" title="Maximize">
                <svg width="12" height="12" viewBox="0 0 12 12">
                    <rect x="1" y="1" width="10" height="10" fill="none" stroke="currentColor" stroke-width="1.5"/>
                </svg>
            </button>
            <button class="title-bar-btn close-btn" id="closeBtn" title="Close">
                <svg width="12" height="12" viewBox="0 0 12 12">
                    <path d="M1 1 L11 11 M11 1 L1 11" stroke="currentColor" stroke-width="1.5"/>
                </svg>
            </button>
        </div>
    </div>
    <div class="app-container" id="appContainer">
        <div class="main-content">
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title-row">
                        <div class="sidebar-title">People</div>
                        <div class="sidebar-controls">
                            <button class="icon-btn" id="filterBtn" title="Filter">
                                <div class="doner-icon">
                                    <div class="doner-line"></div>
                                    <div class="doner-line"></div>
                                    <div class="doner-line"></div>
                                </div>
                            </button>
                            <button class="icon-btn" id="jumpToBtn" title="Jump to">
                                <div class="bento-icon">
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="people-list" id="peopleList"></div>
            </div>

            <div class="content-area">
                <div class="content-header">
                    <div class="content-title" id="contentTitle">Select a person</div>
                    <div class="content-controls">
                        <div class="size-control">
                            <span class="size-label">Size:</span>
                            <input type="range" class="size-slider" id="sizeSlider" min="100" max="300" value="180">
                        </div>
                        <select class="view-dropdown">
                            <option>Show entire photo</option>
                            <option>Zoom to tagged faces</option>
                        </select>
                    </div>
                </div>
                <div class="photo-grid-container">
                    <div class="photo-grid" id="photoGrid"></div>
                </div>
            </div>
        </div>

        <div class="bottom-bar">
            <div class="bottom-content">
                <button class="settings-btn" id="openSettingsBtn">Settings</button>
                <div class="progress-section" id="progressSection">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Initializing...</div>
                </div>
            </div>
            <div class="status-bar">
                <div class="status-info" id="statusInfo">
                    <span class="status-badge">
                        <span class="status-indicator"></span>
                        <span id="pytorchVersion">PyTorch</span>
                    </span>
                    <span id="gpuStatus">Checking...</span>
                    <span id="cudaVersion">CUDA: N/A</span>
                    <span id="faceCount">Found: 0 faces</span>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-container" id="settingsContainer">
            <div class="settings-sidebar">
                <div class="settings-header">
                    <div class="settings-title">Settings</div>
                </div>
                
                <div class="settings-nav">
                    <div class="nav-item active" data-panel="general">General Settings</div>
                    <div class="nav-item" data-panel="folders">Folders to Scan</div>
                    <div class="nav-item" data-panel="log">View Log</div>
                </div>
                
                <div class="settings-footer">
                    <button class="close-settings-btn" id="closeSettingsBtn">Close Settings</button>
                    <div class="footer-credit">Made by RO</div>
                </div>
            </div>
            
            <div class="settings-content">
                <div class="content-panel active" id="general-panel">
                    <div class="panel-title">General Settings</div>
                    
                    <div class="setting-group">
                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Threshold</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">Change threshold values for the AI to detect faces, higher values = stricter match, so similar looking faces will be scrutinized better, but it also may end up creating more persons for different lighting conditions. Default 50%</div>
                                </span>
                            </div>
                            <div class="threshold-control">
                                <div class="threshold-slider-wrapper">
                                    <input type="range" class="threshold-slider" id="thresholdSlider" 
                                           min="10" max="90" value="50">
                                    <span class="threshold-value" id="thresholdValue">50%</span>
                                </div>
                                <button class="recalibrate-btn" id="recalibrateBtn">Recalibrate</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Use system resources dynamically</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">Smartly uses system resources to not hinder user's task. When turn off, the app will perform faster at the cost of fully utilizing system's resources. Default On.</div>
                                </span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Show single unmatched images</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">Faces that have no matches with any other image are hidden by default, as they are likely images users do not care about. Show them grouped under UNMATCHED FACES. Default Off</div>
                                </span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showUnmatchedToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Close to tray</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">Keeps the program running in system's tray when closed, to quit right click the tray icon and select quit. Default On</div>
                                </span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="closeToTrayToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Show hidden person</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">People hidden from the list by the user will shown in the list again as long as this is turned on. You can unhide individual names from the list once visible. Default Off</div>
                                </span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="content-panel" id="folders-panel">
                    <div class="panel-title">Folders to Scan</div>
                    
                    <div class="folder-section">
                        <div class="folder-section-title">
                            <span>Include folders for scanning</span>
                            <span class="info-icon">
                                i
                                <div class="tooltip">Include all folders that will be scanned for photos. Default is the user's photos library on Windows.</div>
                            </span>
                        </div>
                        <div class="folder-list-container" id="includeFolders">
                            <div class="folder-item" data-path="C:\Windows">C:\Windows</div>
                            <div class="folder-item" data-path="D:\Photos">D:\Photos</div>
                        </div>
                        <div class="folder-controls">
                            <button class="folder-btn" id="addIncludeBtn">
                                <span>+</span>
                                <span>Add Folder</span>
                            </button>
                            <button class="folder-btn remove" id="removeIncludeBtn">
                                <span>-</span>
                                <span>Remove Folder</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="folder-section">
                        <div class="folder-section-title">
                            <span>Exclude subfolders from scanning</span>
                            <span class="info-icon">
                                i
                                <div class="tooltip">Exclude subfolders of "included folders" above, that are not to be scanned. This takes precedence over include folders.</div>
                            </span>
                        </div>
                        <div class="folder-list-container" id="excludeFolders">
                            <div class="folder-item" data-path="C:\Windows\System32">C:\Windows\System32</div>
                        </div>
                        <div class="folder-controls">
                            <button class="folder-btn" id="addExcludeBtn">
                                <span>+</span>
                                <span>Add Folder</span>
                            </button>
                            <button class="folder-btn remove" id="removeExcludeBtn">
                                <span>-</span>
                                <span>Remove Folder</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="content-panel" id="log-panel">
                    <div class="log-header">
                        <div class="panel-title">View Log</div>
                        <button class="save-log-btn" id="saveLogBtn">
                            <span>Save Log</span>
                        </button>
                    </div>
                    
                    <div class="log-viewer" id="logViewer">
                        <div class="log-entry">Application started</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="cleanup-overlay" id="cleanupOverlay">
        <div class="cleanup-message">
            <div class="cleanup-title">Cleaning up and quitting</div>
        </div>
    </div>

    <script>
        let people = [];
        let currentPerson = null;
        let isAlphabetMode = false;
        let activeMenu = null;
        let showUnmatched = false;
        const personColors = [
            '#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a',
            '#30cfd0', '#a8edea', '#fed6e3', '#c1dfc4', '#d299c2',
            '#fda085', '#f6d365', '#96e6a1', '#764ba2', '#f79d00'
        ];

        function getPersonColor(personId) {
            return personColors[personId % personColors.length];
        }

        function positionMenu(menu, button) {
            const buttonRect = button.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;

            let top = buttonRect.bottom + 4;
            let left = buttonRect.right - menuRect.width;

            if (top + menuRect.height > viewportHeight) {
                top = buttonRect.top - menuRect.height - 4;
            }

            if (left < 0) {
                left = buttonRect.left;
            }

            if (left + menuRect.width > viewportWidth) {
                left = viewportWidth - menuRect.width - 8;
            }

            menu.style.top = top + 'px';
            menu.style.left = left + 'px';
        }

        async function loadPeople() {
            try {
                people = await pywebview.api.get_people();
                renderPeopleList();
                
                if (people.length > 0) {
                    const firstPerson = people.find(p => p.id !== 0) || people[0];
                    selectPerson(firstPerson);
                }
            } catch (error) {
                console.error('Error loading people:', error);
            }
        }

        function renderPeopleList() {
            const peopleList = document.getElementById('peopleList');
            peopleList.innerHTML = '';
            
            const filteredPeople = people.filter(person => {
                if (person.id === 0 && !showUnmatched) {
                    return false;
                }
                return true;
            });
            
            filteredPeople.forEach(person => {
                const item = document.createElement('div');
                item.className = 'person-item';
                if (currentPerson && person.id === currentPerson.id) {
                    item.classList.add('active');
                }
                
                const color = getPersonColor(person.id);
                const initial = person.name.charAt(0);
                
                item.innerHTML = `
                    <div class="person-avatar" style="background: linear-gradient(135deg, ${color} 0%, ${color}99 100%)">
                        ${initial}
                    </div>
                    <div class="person-info">
                        <div class="person-name">${person.name}</div>
                        <div class="person-count">${person.count} photos</div>
                    </div>
                    <button class="kebab-menu">
                        <span class="kebab-dot"></span>
                        <span class="kebab-dot"></span>
                        <span class="kebab-dot"></span>
                    </button>
                `;
                
                const contextMenu = document.createElement('div');
                contextMenu.className = 'context-menu';
                contextMenu.innerHTML = `
                    <div class="context-menu-item" onclick="renamePerson('${person.name}')">Rename</div>
                    <div class="context-menu-item" onclick="hidePerson('${person.name}')">Hide person</div>
                `;
                document.body.appendChild(contextMenu);
                
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.kebab-menu') && !e.target.closest('.context-menu')) {
                        selectPerson(person);
                    }
                });
                
                peopleList.appendChild(item);

                const kebabBtn = item.querySelector('.kebab-menu');
                kebabBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const personItem = kebabBtn.closest('.person-item');
                    
                    closeAllMenus();
                    
                    contextMenu.classList.add('show');
                    personItem.classList.add('menu-active');
                    activeMenu = { element: contextMenu, parent: personItem };
                    
                    positionMenu(contextMenu, kebabBtn);
                });

                contextMenu.addEventListener('mouseleave', () => {
                    closeAllMenus();
                });
            });
        }

        async function selectPerson(person) {
            currentPerson = person;
            document.getElementById('contentTitle').textContent = `${person.name}'s Photos`;
            
            document.querySelectorAll('.person-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const items = document.querySelectorAll('.person-item');
            items.forEach(item => {
                const nameEl = item.querySelector('.person-name');
                if (nameEl && nameEl.textContent === person.name) {
                    item.classList.add('active');
                }
            });
            
            await loadPhotos(person.clustering_id, person.id);
        }

        async function loadPhotos(clustering_id, person_id) {
            const photoGrid = document.getElementById('photoGrid');
            photoGrid.innerHTML = '<div style="color: #a0a0a0; padding: 20px;">Loading photos...</div>';
            
            try {
                const photos = await pywebview.api.get_photos(clustering_id, person_id);
                photoGrid.innerHTML = '';
                
                if (photos.length === 0) {
                    photoGrid.innerHTML = '<div style="color: #a0a0a0; padding: 20px;">No photos found</div>';
                    return;
                }
                
                photos.forEach(photo => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${photo.thumbnail}" class="photo-placeholder" style="width: 100%; height: 100%; object-fit: cover;">
                        <button class="kebab-menu">
                            <span class="kebab-dot"></span>
                            <span class="kebab-dot"></span>
                            <span class="kebab-dot"></span>
                        </button>
                    `;
                    
                    const contextMenu = document.createElement('div');
                    contextMenu.className = 'context-menu';
                    contextMenu.innerHTML = `
                        <div class="context-menu-item" onclick="makePrimaryPhoto()">Make primary photo</div>
                        <div class="context-menu-item" onclick="removeTag()">Remove tag</div>
                        <div class="context-menu-item" onclick="transferTag()">Transfer tag to someone else</div>
                    `;
                    document.body.appendChild(contextMenu);
                    
                    photoItem.addEventListener('dblclick', () => {
                        pywebview.api.open_photo(photo.path);
                    });
                    
                    photoGrid.appendChild(photoItem);

                    const kebabBtn = photoItem.querySelector('.kebab-menu');
                    kebabBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        closeAllMenus();
                        contextMenu.classList.add('show');
                        photoItem.classList.add('menu-active');
                        activeMenu = { element: contextMenu, parent: photoItem };
                        positionMenu(contextMenu, kebabBtn);
                    });

                    contextMenu.addEventListener('mouseleave', () => {
                        closeAllMenus();
                    });
                });
            } catch (error) {
                console.error('Error loading photos:', error);
                photoGrid.innerHTML = '<div style="color: #ff6b6b; padding: 20px;">Error loading photos</div>';
            }
        }

        function updateStatusMessage(message) {
            document.getElementById('progressText').textContent = message;
            addLogEntry(message);
        }

        function updateProgress(current, total, percent) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `Scanning: ${current}/${total}`;
        }

        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
            updateFaceCount();
        }

        async function updateFaceCount() {
            try {
                const sysInfo = await pywebview.api.get_system_info();
                document.getElementById('faceCount').textContent = `Found: ${sysInfo.total_faces} faces`;
            } catch (error) {
                console.error('Error updating face count:', error);
            }
        }

        function addLogEntry(message) {
            const logViewer = document.getElementById('logViewer');
            const now = new Date();
            const timestamp = now.toLocaleString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${timestamp}] ${message}`;
            logViewer.appendChild(entry);
            logViewer.scrollTop = logViewer.scrollHeight;
        }

        async function initialize() {
            try {
                addLogEntry('Application started');
                
                const sysInfo = await pywebview.api.get_system_info();
                document.getElementById('pytorchVersion').textContent = `PyTorch ${sysInfo.pytorch_version}`;
                document.getElementById('gpuStatus').textContent = sysInfo.gpu_available ? 'GPU Available' : 'CPU Only';
                document.getElementById('cudaVersion').textContent = `CUDA: ${sysInfo.cuda_version}`;
                document.getElementById('faceCount').textContent = `Found: ${sysInfo.total_faces} faces`;
                
                addLogEntry(`System: PyTorch ${sysInfo.pytorch_version}, ${sysInfo.gpu_available ? 'GPU' : 'CPU'}, CUDA ${sysInfo.cuda_version}`);
                
                const threshold = await pywebview.api.get_threshold();
                document.getElementById('thresholdSlider').value = threshold;
                document.getElementById('thresholdValue').textContent = threshold + '%';
                
                const closeToTray = await pywebview.api.get_close_to_tray();
                document.getElementById('closeToTrayToggle').checked = closeToTray;
                
                document.getElementById('progressSection').style.display = 'flex';
                
                const state = await pywebview.api.check_initial_state();
                
                updateStatusMessage('Checking for new photos...');
            } catch (error) {
                console.error('Initialization error:', error);
                addLogEntry('ERROR: Initialization failed - ' + error);
            }
        }

        document.getElementById('sizeSlider').addEventListener('input', (e) => {
            const size = e.target.value;
            document.getElementById('photoGrid').style.gridTemplateColumns = 
                `repeat(auto-fill, minmax(${size}px, 1fr))`;
        });

        const appContainer = document.getElementById('appContainer');
        const settingsOverlay = document.getElementById('settingsOverlay');
        const settingsContainer = document.getElementById('settingsContainer');
        const openSettingsBtn = document.getElementById('openSettingsBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');

        function openSettings() {
            settingsOverlay.classList.add('active');
            appContainer.classList.add('blurred');
        }

        function closeSettings() {
            settingsOverlay.classList.remove('active');
            appContainer.classList.remove('blurred');
        }

        openSettingsBtn.addEventListener('click', openSettings);
        closeSettingsBtn.addEventListener('click', closeSettings);

        settingsOverlay.addEventListener('click', (e) => {
            if (e.target === settingsOverlay) {
                closeSettings();
            }
        });

        settingsContainer.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && settingsOverlay.classList.contains('active')) {
                closeSettings();
            }
        });

        const navItems = document.querySelectorAll('.nav-item');
        const panels = document.querySelectorAll('.content-panel');
        const thresholdSlider = document.getElementById('thresholdSlider');
        const thresholdValue = document.getElementById('thresholdValue');

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                
                const panelId = item.getAttribute('data-panel') + '-panel';
                panels.forEach(panel => panel.classList.remove('active'));
                document.getElementById(panelId).classList.add('active');
            });
        });

        thresholdSlider.addEventListener('input', (e) => {
            thresholdValue.textContent = e.target.value + '%';
            pywebview.api.set_threshold(parseInt(e.target.value));
        });

        document.getElementById('recalibrateBtn').addEventListener('click', async () => {
            const threshold = parseInt(thresholdSlider.value);
            updateStatusMessage('Starting recalibration...');
            document.getElementById('progressSection').style.display = 'flex';
            closeSettings();
            await pywebview.api.recalibrate(threshold);
        });

        document.getElementById('showUnmatchedToggle').addEventListener('change', (e) => {
            showUnmatched = e.target.checked;
            renderPeopleList();
        });

        document.getElementById('closeToTrayToggle').addEventListener('change', (e) => {
            pywebview.api.set_close_to_tray(e.target.checked);
            if (e.target.checked) {
                addLogEntry('Close to tray enabled - tray icon started');
            } else {
                addLogEntry('Close to tray disabled - tray icon removed');
            }
        });

        document.getElementById('saveLogBtn').addEventListener('click', async () => {
            const logViewer = document.getElementById('logViewer');
            const logContent = logViewer.innerText;
            
            try {
                const result = await pywebview.api.save_log(logContent);
                if (result.success) {
                    addLogEntry('Log saved to: ' + result.path);
                } else if (result.message !== 'Save cancelled') {
                    addLogEntry('Error saving log: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving log:', error);
                addLogEntry('Error saving log: ' + error);
            }
        });

        function renamePerson(name) {
            console.log('Rename person:', name);
            closeAllMenus();
        }

        function hidePerson(name) {
            console.log('Hide person:', name);
            closeAllMenus();
        }

        function makePrimaryPhoto() {
            console.log('Make primary photo');
            closeAllMenus();
        }

        function removeTag() {
            console.log('Remove tag');
            closeAllMenus();
        }

        function transferTag() {
            console.log('Transfer tag');
            closeAllMenus();
        }

        function closeAllMenus() {
            document.querySelectorAll('.context-menu').forEach(m => {
                m.classList.remove('show');
            });
            document.querySelectorAll('.person-item, .photo-item').forEach(item => {
                item.classList.remove('menu-active');
            });
            activeMenu = null;
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.kebab-menu') && !e.target.closest('.context-menu')) {
                closeAllMenus();
            }
        });

        document.querySelectorAll('.info-icon').forEach(icon => {
            icon.addEventListener('mouseenter', function() {
                const tooltip = this.querySelector('.tooltip');
                if (!tooltip) return;
                
                const iconRect = this.getBoundingClientRect();
                const tooltipWidth = 320;
                
                let left = iconRect.left + (iconRect.width / 2) - (tooltipWidth / 2);
                let top = iconRect.top - 12;
                
                if (left < 10) left = 10;
                if (left + tooltipWidth > window.innerWidth - 10) {
                    left = window.innerWidth - tooltipWidth - 10;
                }
                
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
                tooltip.style.transform = 'translateY(-100%)';
            });
        });

        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        document.getElementById('minimizeBtn').addEventListener('click', () => {
            pywebview.api.minimize_window();
        });

        document.getElementById('maximizeBtn').addEventListener('click', () => {
            pywebview.api.maximize_window();
        });

        document.getElementById('closeBtn').addEventListener('click', () => {
            pywebview.api.close_window();
        });

        function showCleanupMessage() {
            document.getElementById('cleanupOverlay').classList.add('active');
            document.getElementById('appContainer').classList.add('blurred');
        }

        window.addEventListener('pywebviewready', initialize);
    </script>
</body>
</html>
